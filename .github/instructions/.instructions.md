# eLMo (Loan More App) — Copilot Instructions

These rules guide GitHub Copilot Chat and inline completions across this repository. Keep statements concise and imperative.

---

## applyTo: "\*_/_"

## Global behavior

- Prefer **Rails 8 monolith** patterns. **Do not propose Rails Engines.**
- Assume **Ruby 3.3.x**, **Rails 8**, **PostgreSQL**, **Solid Queue/Cache/Cable**, **Hotwire (Turbo + Stimulus)**.
- **Never** tell the user to run `rails console` or `rails server`.
- Generate code that is idempotent, secure by default, and production-oriented.
- Prefer clear, commented examples over magic; cite file paths.
- When you invent config/constants (e.g., interest rates), place them in settings, not hardcoded literals.

## Architecture & conventions

- Use namespaced modules within `app/` (monolith): `app/models`, `app/services`, `app/queries`, `app/commands`, `app/jobs`, `app/policies`, `app/validators`, `app/forms`.
- Favor "service object + PORO" over fat controllers/models. Keep controllers thin; move domain logic to services/commands.
- Use UUID primary keys and timestamps; add **database constraints** matching model validations.
- Use background jobs via **ActiveJob + Solid Queue** for side effects (notifications, scoring, exports).
- Keep external boundaries explicit: gateways/adapters in `app/integrations/*`.

## Coding style

- Follow **Standard Ruby** or RuboCop defaults (no bikeshedding). Prefer early returns; avoid deep nesting.
- Method length ≤ ~20 lines when feasible; extract intentful helpers.
- Strictness: freeze constants, use keyword args for options, avoid global state.

## Security & privacy

- Load secrets via `Rails.application.credentials`/ENV. **Never** commit tokens/keys.
- Validate and sanitize all user input; strong parameters only.
- Avoid leaking PII in logs; tag sensitive attributes as filtered parameters.

## Testing (RSpec-first)

- Every feature must include **unit + request/system specs**.
- Write both **happy** and **unhappy** paths; include boundary cases and authorization.
- Prefer **FactoryBot** with traits; use **Faker** sparingly and deterministically.
- Use **Shoulda Matchers** for concise model specs; assert DB indexes/constraints via migrations specs when risky changes exist.
- Mock external services behind adapter interfaces; use **WebMock/VCR** only at boundary tests.

### RSpec templates (use/adapt)

```ruby
# spec/requests/<resource>_spec.rb
RSpec.describe "/<resource>", type: :request do
  describe "POST /" do
    it "creates with valid params" do
      # arrange
      # act
      # assert: status, JSON shape, side effects
    end

    it "rejects invalid params" do
      # assert 422, error messages
    end

    it "requires auth/permissions" do
      # assert 401/403
    end
  end
end

# spec/models/<model>_spec.rb
RSpec.describe <Model>, type: :model do
  describe "validations" do
    it { is_expected.to validate_presence_of(:...) }
  end

  describe "scopes" do
    it "returns only ..." do
      # setup 2-3 records, expect
    end
  end

  describe "business rules" do
    it "calculates ..." do
      # unit of work, pure function expectations
    end
  end
end
```

---

## applyTo: "db/migrate/\*_/_.rb"

## Migrations

- Add indexes for foreign keys and lookups; add unique indexes for natural keys (e.g., emails).
- For large tables: use disable_ddl_transaction! + algorithm: :concurrently where supported; avoid table locks.
- Backfill with data migrations in idempotent steps; avoid long-running transactions.

---

## applyTo: "app/models/\*_/_.rb"

## Models

- Keep models slim: validations, relations, scopes only; move complex logic to app/services.
- Always validate presence and format of external identifiers; add corresponding DB constraints.
- Use enum with string backing (not integers) for auditability.

---

## applyTo: "app/services/\*_/_.rb"

## Services/Commands

- Single responsibility; return Result objects (e.g., Dry::Monads-like or a simple ServiceResult with success?, value, errors).
- No DB transactions across multiple services unless coordinated in a dedicated orchestrator.

---

## applyTo: "app/jobs/\*_/_.rb"

## Jobs

- Keep perform minimal; delegate to services. Use retries with backoff; mark jobs as unique when dedup required.

---

## applyTo: "app/controllers/\*_/_.rb"

## Controllers

- Use responders or explicit render json: with serializers; avoid leaking ActiveRecord objects without serialization.
- Handle errors consistently (422 validation, 400 bad request, 401/403 authz, 404 not found, 500 fallback).

---

## applyTo: "app/serializers/\*_/_.rb"

## Serialization

- Prefer lightweight, explicit serializers (e.g., ActiveModel::Serializer or POROs). Do not over-nest. Include pagination meta where applicable.

---

## applyTo: "config/\*_/_.yml"

## Configuration

- Keep environment-specific settings in config/\*.yml or credentials; no secrets in code.
- Feature flags via ENV/credentials; default to off in production unless explicitly enabled.

---

## applyTo: "app/javascript/\*_/_.{js,ts}"

## Front-end (Hotwire)

- Use Stimulus controllers for behavior; do not introduce SPA frameworks unless explicitly requested.
- Keep controllers small; extract helpers; no inline script tags in views when avoidable.

---

## applyTo: ".github/workflows/\*.yml"

## CI

- Ensure matrix covers Ruby 3.3.x on Ubuntu. Steps: setup Ruby, bundle install, DB setup (PostgreSQL), bin/rails db:schema:load, rspec.
- Fail fast on RuboCop offenses; run `bundle exec rspec --format documentation --profile`.

---

## applyTo: "spec/\*_/_.rb"

## Test writing rules

- Use let_it_be / before(:all) sparingly; prefer let/before(:each) for isolation.
- Prefer build_stubbed to avoid unnecessary DB writes.
- Name examples with behavior-driven phrasing: returns 422 when amount exceeds limit.

---

## applyTo: "app/\*_/_.rb"

## Domain hints (eLMo)

- Loan tiers: do not hardcode rates; read from config (e.g., daily 0.5%, monthly 3–3.49%). Validate by tier.
- Credit scoring is a service; keep explainability hooks (reason codes) for decisions.
- Monetary values are decimal with precision/scale; never floats. Use minor units for calculations where applicable.

---

## applyTo: "\*_/_"

## Answering style for Copilot Chat

- Be step-by-step and concrete; reference exact files/lines when possible.
- Prefer minimal diffs and complete code blocks the user can paste.
- For commands, prefix with the required PATH snippet (see Global behavior).
- When uncertain, state assumptions explicitly and propose a safe default.
